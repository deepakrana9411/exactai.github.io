<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eXact AI - Your Personal Assistant</title>
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c63ff;
            --user-message-bg: #4a6cf7; /* Renamed for clarity */
            --bot-message-bg: rgba(255, 255, 255, 0.1); /* Renamed, using your card-bg */
            --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --chat-background: rgba(255, 255, 255, 0.08);
            --message-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            /* --card-bg: rgba(255, 255, 255, 0.1); */ /* Using bot-message-bg instead */
            --text-light: #ffffff;
            --text-dark: #333333; /* Not heavily used in this dark theme */
            --border-color-light: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--background-gradient);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* To prevent body scrollbars if chat is large */
        }

        /* Chatbot Launcher Icon (if chat is closed initially) */
        #exact-ai-launcher {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px; /* Icon size */
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            display: none; /* Initially hidden, shown by JS if chat is closed */
            justify-content: center;
            align-items: center;
            z-index: 9998;
            transition: transform 0.2s ease-in-out, opacity 0.3s;
        }
        #exact-ai-launcher:hover {
            transform: scale(1.1);
        }


        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 85vh;
            background: var(--chat-background);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex; /* Will be controlled by JS for open/close */
            flex-direction: column;
            position: relative; /* Keep relative for absolute positioned children */
            border: 1px solid var(--border-color-light);
            /* For resize (optional, uncomment if needed) */
            /* resize: both; */
            /* min-width: 350px; */
            /* min-height: 500px; */
            /* max-width: 95vw; */
            /* max-height: 90vh; */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* For open/close animation */
            opacity: 1; /* Default to visible, JS will manage based on localStorage */
            transform: scale(1);
        }

        .chat-container.hidden-chat { /* Class to hide chat and show launcher */
            opacity: 0;
            transform: scale(0.95) translateY(20px);
            pointer-events: none; /* Prevent interaction when hidden */
            display: none !important; /* Ensure it's hidden */
        }


        .chat-header {
            background: rgba(26, 26, 46, 0.8); /* Darker, slightly transparent */
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color-light);
            position: relative; /* Or sticky if you want it to stick on scroll of container */
            z-index: 10;
            cursor: grab; /* For potential dragging if implemented */
        }

        .chat-header h2 {
            font-size: 1.4rem; /* Slightly adjusted */
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--text-light);
        }

        .close-btn { /* Your existing close button */
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: rotate(90deg);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px; /* Slightly reduced gap */
            position: relative; /* For absolutely positioned elements within messages if any */
        }

        /* Custom scrollbar for webkit browsers */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }


        .message {
            max-width: 75%; /* Adjusted for better balance */
            padding: 12px 18px; /* Adjusted padding */
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            box-shadow: var(--message-shadow);
            line-height: 1.5;
            word-wrap: break-word;
            display: flex;
            flex-direction: column; /* To stack content and timestamp/copy */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: var(--user-message-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background: var(--bot-message-bg);
            color: var(--text-light);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-content {
            font-size: 0.95rem; /* Slightly adjusted */
        }
        .message-content pre { /* For Markdown code blocks if not handled by .code-block */
            background-color: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            margin: 8px 0;
            white-space: pre-wrap; /* Important for wrapping long lines in code */
            word-wrap: break-word;
        }
        .message-content table {
            width: 100%; border-collapse: collapse; margin: 10px 0;
            font-size: 0.85em; background: rgba(0,0,0,0.1);
            border: 1px solid var(--border-color-light);
            border-radius: 6px;
            overflow: hidden; /* Clip content within rounded corners */
        }
        .message-content th, .message-content td {
            border: 1px solid var(--border-color-light); padding: 8px; text-align: left;
        }
        .message-content th {
            background-color: rgba(255,255,255,0.05); font-weight: 600;
        }


        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .message-timestamp {
            font-size: 0.7rem; /* Smaller timestamp */
            opacity: 0.6;
        }

        .copy-message-btn { /* Specific class for copying entire message text */
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 4px;
            color: var(--text-light);
            padding: 3px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.3s;
            opacity: 0.7;
        }
        .copy-message-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            opacity: 1;
        }
        .copy-message-btn:disabled {
             background: rgba(255, 255, 255, 0.1); opacity: 0.5; cursor: default;
        }


        /* Code Block specific styling from your example, integrated */
        .code-block { /* This is for your JS detection of ``` */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0; /* Add some margin */
            position: relative;
            overflow-x: auto; /* Ensure horizontal scroll for long code */
        }
         .code-block pre { /* Style for the pre tag inside your code-block div */
            margin: 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: var(--text-light);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .code-block .copy-code-btn { /* Specific button for code block */
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 1;
        }
        .code-block .copy-code-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .code-block .copy-code-btn:disabled {
            background: rgba(255,255,255,0.1); opacity: 0.7; cursor: default;
        }


        .chat-input-container {
            padding: 15px 20px;
            background: rgba(26, 26, 46, 0.8); /* Match header */
            border-top: 1px solid var(--border-color-light);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center; /* Vertically align input and button */
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent; /* Start with transparent border */
            border-radius: 25px;
            padding: 14px 20px; /* Adjusted padding */
            color: var(--text-light);
            font-size: 1rem; /* Adjusted font size */
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary-color); /* Use border for focus instead of shadow */
            /* box-shadow: 0 0 0 2px var(--primary-color); */
        }

        .send-btn {
            background: var(--primary-color);
            border: none;
            width: 48px; /* Adjusted size */
            height: 48px; /* Adjusted size */
            border-radius: 50%;
            color: white;
            font-size: 20px; /* Icon size */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .send-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }
        .send-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: scale(1);
        }

        .loading-indicator {
            display: none; /* Initially hidden, controlled by JS */
            justify-content: flex-start; /* Align to left like bot messages */
            padding: 0 20px 10px 20px; /* Match message padding but only bottom */
        }
        .loading-indicator.visible { /* Class to show loading */
            display: flex;
        }

        .loading-dots-container { /* Wrapper for styling like a bot message */
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 18px;
            background: var(--bot-message-bg);
            box-shadow: var(--message-shadow);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: center;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .dot {
            width: 10px; /* Adjusted size */
            height: 10px; /* Adjusted size */
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both; /* Adjusted timing */
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }


        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* 3D Design Elements (Your existing CSS for these) */
        .design-element { position: absolute; pointer-events: none; z-index: 0;}
        .cube {
            width: 100px; height: 100px; top: 10%; left: 5%;
            transform-style: preserve-3d; animation: rotate 20s infinite linear;
        }
        .face {
            position: absolute; width: 100px; height: 100px;
            background: rgba(106, 90, 205, 0.15); border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .front { transform: translateZ(50px); }
        .back { transform: rotateY(180deg) translateZ(50px); }
        .right { transform: rotateY(90deg) translateZ(50px); }
        .left { transform: rotateY(-90deg) translateZ(50px); }
        .top { transform: rotateX(90deg) translateZ(50px); }
        .bottom { transform: rotateX(-90deg) translateZ(50px); }

        .pyramid {
            width: 80px; height: 80px; bottom: 15%; right: 10%;
            transform-style: preserve-3d; animation: rotateReverse 25s infinite linear;
        }
        .pyramid-face {
            position: absolute; width: 0; height: 0;
            border-left: 40px solid transparent; border-right: 40px solid transparent;
            border-bottom: 70px solid rgba(74, 108, 247, 0.15); transform-origin: bottom;
        }
        .pyramid-face:nth-child(1) { transform: rotateY(0deg) translateZ(20px); }
        .pyramid-face:nth-child(2) { transform: rotateY(90deg) translateZ(20px); }
        .pyramid-face:nth-child(3) { transform: rotateY(180deg) translateZ(20px); }
        .pyramid-face:nth-child(4) { transform: rotateY(270deg) translateZ(20px); }

        @keyframes rotate {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
        }
        @keyframes rotateReverse {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(-360deg) rotateY(-360deg) rotateZ(-360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body { padding: 0; } /* Full bleed on smaller screens */
            .chat-container {
                height: 100vh; /* Full height */
                max-height: 100vh;
                width: 100vw; /* Full width */
                max-width: 100vw;
                border-radius: 0; /* No border radius for full screen */
                /* resize: none;  Remove resize on mobile if it was enabled */
            }
            .message { max-width: 85%; }
            .chat-header h2 { font-size: 1.2rem; }
            .chat-input { padding: 12px 16px; font-size: 0.95rem; }
            .send-btn { width: 45px; height: 45px; }
            .design-element { display: none; } /* Hide 3D elements on small screens */
            #exact-ai-launcher { bottom: 15px; right: 15px; width: 50px; height: 50px; }
        }

        /* Remove launcher and 3D elements on very small screens if chat is full screen */
        @media (max-width: 480px) {
             /* .chat-container being full screen already handled by 768px */
            .chat-header { padding: 12px 15px; }
            .chat-header h2 { font-size: 1.1rem;}
            .logo { width: 30px; height: 30px; font-size: 16px; }
            .close-btn { width: 30px; height: 30px; font-size: 16px;}
            .chat-messages { padding: 15px; gap: 15px; }
            .message { padding: 10px 15px; max-width: 90%; }
            .message-content { font-size: 0.9rem; }
            .chat-input-container { padding: 10px 15px; }
            .input-wrapper { gap: 8px; }
            .send-btn { width: 42px; height: 42px; font-size: 18px; }
            /* Launcher visibility on mobile should be handled by JS based on chat state */
        }
    </style>
</head>
<body>
    <!-- 3D Design Elements -->
    <div class="design-element cube">
        <div class="face front"></div><div class="face back"></div><div class="face right"></div>
        <div class="face left"></div><div class="face top"></div><div class="face bottom"></div>
    </div>
    <div class="design-element pyramid">
        <div class="pyramid-face"></div><div class="pyramid-face"></div>
        <div class="pyramid-face"></div><div class="pyramid-face"></div>
    </div>
    
    <!-- Chatbot Launcher Icon -->
    <button id="exact-ai-launcher" aria-label="Open Chat">💬</button>

    <!-- Chat Container -->
    <div class="chat-container" id="exact-ai-chat-widget">
        <div class="chat-header">
            <h2>
                <div class="logo">eX</div>
                eXact AI
            </h2>
            <button class="close-btn" id="exact-ai-close-btn" aria-label="Close Chat">✖</button>
        </div>
        
        <div class="chat-messages" id="exact-ai-messages-area">
            <!-- Initial welcome message can be added by JS -->
        </div>
        
        <div class="loading-indicator" id="exact-ai-loading-indicator">
            <div class="loading-dots-container">
                <div class="loading-dots">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="exact-ai-user-input" 
                    placeholder="Ask about 3D design..."
                >
                <button class="send-btn" id="exact-ai-send-btn" aria-label="Send Message">➤</button>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            // --- DOM Elements ---
            const chatWidget = document.getElementById('exact-ai-chat-widget');
            const launcherButton = document.getElementById('exact-ai-launcher');
            const closeButton = document.getElementById('exact-ai-close-btn');
            const messagesArea = document.getElementById('exact-ai-messages-area');
            const userInput = document.getElementById('exact-ai-user-input');
            const sendButton = document.getElementById('exact-ai-send-btn');
            const loadingIndicator = document.getElementById('exact-ai-loading-indicator');

            // --- API Configuration ---
            const API_KEY = "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";
            const API_URL = "https://openrouter.ai/api/v1/chat/completions";
            const YOUR_SITE_URL = window.location.href; // Or your specific site URL
            const X_TITLE = "eXact Ai By Deepak Rana";

            // --- localStorage Keys ---
            const LS_CHATBOT_OPEN_KEY = 'exactAiChatbotOpen_v2'; // Use new key for new design
            // const LS_CHATBOT_SIZE_KEY = 'exactAiChatbotSize_v2'; // For resize feature if added

            let conversationHistory = [
                {
                    role: "system",
                    content: "You are eXact AI, personal assistant and advanced 3D design assistant created by Deepak Rana. You are conversational, helpful, and specialize in 3D modeling, texturing, rendering, and animation. When presenting tabular data, use Markdown table format. If code is requested, provide it within Markdown code blocks (e.g., ```python ... ```). Be friendly and engaging."
                }
            ];

            // --- Initialization ---
            function initializeChatbotState() {
                // Load saved open state
                const savedOpenState = localStorage.getItem(LS_CHATBOT_OPEN_KEY);
                if (savedOpenState === 'false') { // Explicitly closed
                    closeChatbotUI(false); // Close without animation and don't re-save state
                } else { // Default to open or if was previously open
                    openChatbotUI(false); 
                    // Add a welcome message if it's the first time or messages area is empty and chat is open
                    if (messagesArea.children.length === 0) {
                        addMessageToUI("👋 Hello! I'm eXact AI Created by Deepak Rana. How can I help with your 3D design questions today?", 'bot', true);
                    }
                }
                // Resize logic would go here if implemented
            }

            // --- Event Listeners ---
            launcherButton.addEventListener('click', () => openChatbotUI(true));
            closeButton.addEventListener('click', () => closeChatbotUI(true));
            sendButton.addEventListener('click', handleSendMessage);
            userInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleSendMessage();
                }
            });
            // Resize observer would go here if implemented

            // --- Core UI Functions ---
            function openChatbotUI(saveState = true) {
                chatWidget.classList.remove('hidden-chat');
                launcherButton.style.display = 'none';
                userInput.focus();
                if (saveState) {
                    localStorage.setItem(LS_CHATBOT_OPEN_KEY, 'true');
                }
            }

            function closeChatbotUI(saveState = true) {
                chatWidget.classList.add('hidden-chat');
                launcherButton.style.display = 'flex'; // Show launcher
                if (saveState) {
                    localStorage.setItem(LS_CHATBOT_OPEN_KEY, 'false');
                }
            }
            
            function addMessageToUI(messageText, sender, isInitialMessage = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');

                // Process for code blocks (```) and tables (Markdown)
                processMessageContent(messageText, contentDiv, sender);
                messageDiv.appendChild(contentDiv);

                const footerDiv = document.createElement('div');
                footerDiv.classList.add('message-footer');

                const timestamp = document.createElement('div');
                timestamp.classList.add('message-timestamp');
                timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                footerDiv.appendChild(timestamp);

                if (sender === 'bot' && !isInitialMessage) { // Don't add copy for initial hardcoded message
                    const copyBtn = document.createElement('button');
                    copyBtn.classList.add('copy-message-btn');
                    copyBtn.textContent = 'Copy';
                    copyBtn.setAttribute('aria-label', 'Copy message');
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(messageText).then(() => {
                            copyBtn.textContent = 'Copied!';
                            copyBtn.disabled = true;
                            setTimeout(() => {
                                copyBtn.textContent = 'Copy';
                                copyBtn.disabled = false;
                            }, 2000);
                        }).catch(err => console.error('Failed to copy: ', err));
                    });
                    footerDiv.appendChild(copyBtn);
                }
                messageDiv.appendChild(footerDiv);
                messagesArea.appendChild(messageDiv);
                scrollToBottom();
            }

            function processMessageContent(rawMessage, targetElement, sender) {
                // Basic Markdown Table Detection & Rendering
                const tableRegex = /(\|.*\|[\r\n]+)((?:\|.*(?:---).*\|[\r\n]+)+)((?:\|.*\|[\r\n]+)*)/gm;
                let lastIndex = 0;
                let match;
            
                // Your ``` code block detection (from your original script)
                if (rawMessage.includes('```')) {
                    const parts = rawMessage.split('```');
                    for (let i = 0; i < parts.length; i++) {
                        const partText = parts[i].trim();
                        if (i % 2 === 1) { // Code block
                            const langMatch = partText.match(/^(\w+)\n/); // Check for language hint
                            const language = langMatch ? langMatch[1] : '';
                            const code = langMatch ? partText.substring(language.length).trim() : partText;

                            const codeBlockDiv = document.createElement('div');
                            codeBlockDiv.classList.add('code-block');
                            if (language) codeBlockDiv.classList.add(`language-${language}`);
                            
                            const pre = document.createElement('pre');
                            // const codeTag = document.createElement('code'); // Optional: for semantic HTML
                            // codeTag.textContent = code;
                            // pre.appendChild(codeTag);
                            pre.textContent = code; // Simpler
                            
                            codeBlockDiv.appendChild(pre);

                            const copyCodeBtn = document.createElement('button');
                            copyCodeBtn.classList.add('copy-code-btn');
                            copyCodeBtn.textContent = 'Copy Code';
                            copyCodeBtn.addEventListener('click', function() {
                                navigator.clipboard.writeText(code).then(() => {
                                    copyCodeBtn.textContent = 'Copied!';
                                    copyCodeBtn.disabled = true;
                                    setTimeout(() => {
                                        copyCodeBtn.textContent = 'Copy Code';
                                        copyCodeBtn.disabled = false;
                                    }, 2000);
                                });
                            });
                            codeBlockDiv.appendChild(copyCodeBtn);
                            targetElement.appendChild(codeBlockDiv);
                        } else if (partText) { // Regular text part
                            const textNode = document.createElement('span'); // Use span for inline-block behavior within flex
                            textNode.innerHTML = partText.replace(/\n/g, '<br>'); // Preserve line breaks
                            targetElement.appendChild(textNode);
                        }
                    }
                } else if ((match = tableRegex.exec(rawMessage)) !== null && sender === 'bot') {
                     // Attempt to parse and render Markdown tables (simplified)
                    const fullTableMarkdown = match[0];
                    const tableElement = tryParseAndRenderMarkdownTable(fullTableMarkdown);
                    if (tableElement) {
                        targetElement.appendChild(tableElement);
                    } else {
                        const pre = document.createElement('pre');
                        pre.textContent = rawMessage; // Fallback to preformatted text
                        targetElement.appendChild(pre);
                    }
                } else { // Default: treat as plain text, preserve line breaks
                    const pre = document.createElement('pre');
                    pre.textContent = rawMessage;
                    targetElement.appendChild(pre);
                }
            }
            
            function tryParseAndRenderMarkdownTable(markdown) {
                // (Using a slightly simplified version of the previous table parser)
                const lines = markdown.trim().split('\n').map(line => line.trim()).filter(line => line.startsWith('|'));
                if (lines.length < 2) return null; // Need header and separator at least

                const table = document.createElement('table');
                const thead = table.createTHead();
                const tbody = table.createTBody();

                // Header
                const headerCells = lines[0].slice(1, -1).split('|').map(cell => cell.trim());
                const headerRow = thead.insertRow();
                headerCells.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });

                // Separator line (lines[1]) - we assume it's valid if we reach here
                // Data rows
                for (let i = 2; i < lines.length; i++) {
                    const dataCells = lines[i].slice(1, -1).split('|').map(cell => cell.trim());
                    const dataRow = tbody.insertRow();
                    dataCells.forEach(text => {
                        const td = dataRow.insertCell();
                        td.textContent = text;
                    });
                     // Ensure all rows have same number of cells as header
                    for (let k = dataCells.length; k < headerCells.length; k++) {
                        dataRow.insertCell();
                    }
                }
                return (thead.rows[0] && thead.rows[0].cells.length > 0) ? table : null;
            }


            function showLoading(show) {
                if (show) {
                    loadingIndicator.classList.add('visible');
                    sendButton.disabled = true;
                    userInput.disabled = true;
                } else {
                    loadingIndicator.classList.remove('visible');
                    sendButton.disabled = false;
                    userInput.disabled = false;
                    userInput.focus();
                }
            }

            function scrollToBottom() {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            // --- API Call & Message Handling ---
            async function handleSendMessage() {
                const messageText = userInput.value.trim();
                if (!messageText) return;

                addMessageToUI(messageText, 'user');
                conversationHistory.push({ role: "user", content: messageText });
                userInput.value = '';
                showLoading(true);

                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_KEY}`,
                            "HTTP-Referer": YOUR_SITE_URL,
                            "X-Title": X_TITLE,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "model": "qwen/qwen2.5-vl-72b-instruct:free", // Or your preferred model
                            "messages": conversationHistory
                        })
                    });

                    showLoading(false);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        console.error("API Error:", errorData);
                        addMessageToUI(`Error: ${errorData.error?.message || 'Failed to get response.'}`, 'bot');
                        return;
                    }

                    const data = await response.json();
                    let botReply = "Sorry, I couldn't process that.";
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        botReply = data.choices[0].message.content;
                    }
                    
                    addMessageToUI(botReply, 'bot');
                    conversationHistory.push({ role: "assistant", content: botReply });

                } catch (error) {
                    showLoading(false);
                    console.error("Fetch Error:", error);
                    addMessageToUI("Oops! Something went wrong. Please try again.", 'bot');
                }
            }

            // --- Initialize Chatbot on Page Load ---
            document.addEventListener('DOMContentLoaded', initializeChatbotState);

        })();
    </script>
</body>
</html>